#!/usr/bin/env bash
set -euo pipefail

# Get directory of script
SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"

# Make directory for state if none
STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/teevee"
mkdir -p "$STATE_DIR"

# Development or installed paths
if [[ -d "$SCRIPT_DIR/lib" ]]; then
    # Running from project directory
    TEEVEE_ROOT="$SCRIPT_DIR"
else
    # Running from installed location
    TEEVEE_ROOT="/usr/share/teevee"
fi

TEEVEE_USER_CONFIG="${XDG_CONFIG_HOME:-$HOME/.config}/teevee"

# Load libraries
source "$TEEVEE_ROOT/lib/utils.sh"
source "$TEEVEE_ROOT/lib/launcher.sh"
source "$TEEVEE_ROOT/lib/state.sh"
source "$TEEVEE_ROOT/lib/timer.sh"
source "$TEEVEE_ROOT/lib/config.sh"
source "$TEEVEE_ROOT/lib/dunst.sh"

# Parse flags
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            print_help
            exit 0
            ;;
        -v|--version)
            echo "telly 0.2.0"
            exit 0
            ;;
        -V|--valid)
            shift
            if [[ $# -eq 0 || "$1" == -* ]]; then
                die "-V/--valid requires a launcher name"
            fi
            find_launcher "$1"
            echo "$1 is a valid launcher"
            exit 0
            ;;
        --)
            shift
            break
            ;;
        -*)
            die "Unknown option $1" 
            ;;
        *)
            break
            ;;
    esac
done


# Interpret command
cmd="${1:-}"
case "$cmd" in
    run)
        launcher="${2:-}"
        [[ -z "$launcher" ]] && die 'missing launcher name'

        # Get launcher directory and contents
        launcher_dir="$(find_launcher "$launcher")"
        load_launcher_config "$launcher_dir"

        # REPLACED WITH OPTION_ORDER
        # options=($(get_options "$launcher_dir"))
        echo "Running launcher: $launcher"

        # Get state file and state
        state_file="$(state_file_for "$launcher")"
        load_state "$state_file"
        # Stop current timer
        stop_timer "$launcher"

        # Cycle
        if (( LAST_TS > 0 )); then
            INDEX="$(next_index "$INDEX" "${#OPTION_ORDER[@]}")"
        fi
        # Save the new state
        now="$(date +%s)"
        save_state "$state_file" "$INDEX" "$now"
        
        # Form menu text
        menu_text="${TITLE}"$'\n'
        for i in "${!OPTIONS[@]}"; do
            if (( i == INDEX )); then
                menu_text+="${HOVER_OPTIONS[i]}"$'\n'
            else
                menu_text+="${OPTIONS[i]}"$'\n'
            fi
        done
        # Remove trailing newline
        menu_text="${menu_text%$'\n'}"
        # Show notification and store ID
        nid="$(show_menu_notification "$launcher" "$menu_text" "$INDEX")"

        echo "$nid" >"$(notification_id_file "$launcher")"

        start_timer "$launcher" "$TIMEOUT_MS" "${OPTION_ORDER[$INDEX]}"
        ;;
    list)
        list_launchers
        ;;
    init)
        shift
        # Instantiate .config/teevee directory
        create_config
        if [[ $# == 1 ]]; then
            # Create a launcher if the user specifies
            create_launcher "$1"
        fi
        ;;
    *)
        echo "Usage: teevee run <launcher>"
        ;;
esac
